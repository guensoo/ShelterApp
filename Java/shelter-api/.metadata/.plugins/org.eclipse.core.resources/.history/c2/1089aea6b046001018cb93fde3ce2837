package com.shelter.shelter_api.Service;

import java.util.Collections;
import java.util.List;
import java.util.stream.Collectors;

import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.shelter.shelter_api.DTO.ColdShelterDTO;
import com.shelter.shelter_api.Entity.ColdShelterEntity;
import com.shelter.shelter_api.Repository.ColdShelterRepository;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Service
@RequiredArgsConstructor
public class ColdShelterService {

    private final ColdShelterRepository repository;
    private final ObjectMapper objectMapper;

    private static final String API_URL = 
    		  "https://www.safetydata.go.kr/V2/api/DSSP-IF-10804?serviceKey=7TH2H36WY8VW30FM&returnType=json";


    // ✅ 1. 외부 API 호출 및 저장
    public int fetchAndSaveFromApi() {
        try {
            RestTemplate restTemplate = new RestTemplate();
            ResponseEntity<String> response = restTemplate.getForEntity(API_URL, String.class);

            JsonNode bodyNode = objectMapper.readTree(response.getBody()).path("body");

            List<ColdShelterDTO> dtoList = objectMapper.readValue(
                    bodyNode.toString(), new TypeReference<List<ColdShelterDTO>>() {}
            );

            return saveAll(dtoList);
        } catch (Exception e) {
            log.error("❌ 한파쉼터 API 저장 실패", e);
            return 0;
        }
    }

    // ✅ 2. DTO → Entity 변환 후 DB 저장
    public int saveAll(List<ColdShelterDTO> dtoList) {
        List<ColdShelterEntity> entities = dtoList.stream()
                .map(this::convertToEntity)
                .collect(Collectors.toList());

        repository.saveAll(entities);
        log.info("✅ 저장 완료: {}건", entities.size());
        return entities.size();
    }

    private ColdShelterEntity convertToEntity(ColdShelterDTO dto) {
        return ColdShelterEntity.builder()
                .reareNm(dto.getReareNm())
                .reareFcltNo(dto.getReareFcltNo())
                .fcltType(dto.getFcltType())
                .fcltySclas(dto.getFcltySclas())
                .daddr(dto.getDaddr())
                .ronaDaddr(dto.getRonaDaddr())
                .lat(dto.getLat())
                .lot(dto.getLot())
                .wkdyOperBgngHr(dto.getWkdyOperBgngHr())
                .wkdyOperEndHr(dto.getWkdyOperEndHr())
                .lhhldyOperBgngHr(dto.getLhhldyOperBgngHr())
                .lhhldyOperEndHr(dto.getLhhldyOperEndHr())
                .sndyOperBgngHr(dto.getSndyOperBgngHr())
                .sndyOperEndHr(dto.getSndyOperEndHr())
                .stdyOperBgngHr(dto.getStdyOperBgngHr())
                .stdyOperEndHr(dto.getStdyOperEndHr())
                .utztnPsbltyTnop(dto.getUtztnPsbltyTnop())
                .rmrk(dto.getRmrk())
                .mdfcnHr(dto.getMdfcnHr())
                .build();
    }
    
    public List<ColdShelterDTO> fetchFromApiOnly() {
        try {
            RestTemplate restTemplate = new RestTemplate();
            String url = API_URL + "&returnType=json";
            ResponseEntity<String> response = restTemplate.getForEntity(url, String.class);

            JsonNode root = objectMapper.readTree(response.getBody());
            JsonNode bodyArray = root.path("body");

            List<ColdShelterDTO> dtoList = objectMapper.readValue(
                bodyArray.toString(), new TypeReference<List<ColdShelterDTO>>() {}
            );

            return dtoList;
        } catch (Exception e) {
            log.error("❌ fetchOnly 실패", e);
            return Collections.emptyList();
        }
    }
}
